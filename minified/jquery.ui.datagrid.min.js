/*!
 * jQuery UI datagrid
 * 
 * @autor:.....: Juarez Gon√ßalves Nery Junior
 * @email:.....: juareznjunior@gmail.com
 * @twitter:...: @juareznjunior
 * @date.......: 2013-08-23
 * 
 * Depends:
 *	 jquery.ui.core.js
 *	 jquery.ui.widget.js
 *	 jquery.ui.button.js
 */
;(function(b,q,r,h){var p=Number(b.ui.version.replace(/[^0-9]/g,""));b.widget("ui.datagrid",{options:{limit:20,mapper:[],height:200,jsonStore:{url:"",params:{},data:{}},pagination:!0,refresh:!1,rowNumber:!1,fit:!1,autoRender:!0,autoLoad:!0,ajaxMethod:"GET",title:"",onClickRow:!1,onComplete:!1,onAjaxSuccess:!1,onError:!1,emptyDataMessage:"Empty rows",toolBarButtons:!1},_create:function(){"none"===this.element.css("display")&&this.element.show();var a=[],c;this.uiDataGrid=b('<div class="ui-datagrid-container ui-widget ui-widget-content ui-corner-all"><div class="ui-datagrid-title"><div class="ui-widget-header"></div></div><div class="ui-datagrid-content"><div class="ui-datagrid-content-scroll"><div class="ui-datagrid-header ui-state-default"><table><thead><tr><th><table class="ui-datagrid"><colgroup></colgroup><thead><tr role="rowheader"></tr></thead></table></th><th></th></tr></thead></table></div><div class="ui-widget-content ui-datagrid-body"><table class="ui-datagrid"><colgroup></colgroup><thead><tr role="rowheader"></tr></thead><tbody></tbody></table></div></div></div><div class="ui-widget ui-state-default ui-datagrid-tools"><table class="ui-datagrid"><tbody><tr><td>&nbsp;</td><td style="visibility:hidden"><span></span></td></tr></tbody></table></div></div>');
this.uiDataGrid.find("table").filter(function(){b(this).hasClass("ui-datagrid")?a.push(this):c=this.parentNode.parentNode}).end();""===this.options.title?b(c.parentNode).prev().remove():b(c.parentNode).prev().children().text(this.options.title);!1===b.isArray(this.options.toolBarButtons)&&!1===this.options.pagination&&b(a[2].parentNode).remove();this.uiDataGridThead=b(a[0].tHead);this.uiDataGridTheadBody=b(a[1].tHead);this.uiDataGridColGroup1=this.uiDataGridThead.prev();this.uiDataGridColGroup2=this.uiDataGridTheadBody.prev();
this.uiDataGridTbody=b(a[1].tBodies[0]);this.uiDataGridTfoot=this.options.pagination||b.isArray(this.options.toolBarButtons)?b(a[2].tBodies[0]):b([]);this.uiDataGridScrollBody=b(a[1].parentNode).height(this.options.height);this.uiDataGridScrollMain=b(c);this.uiDataGridTdPagination={childs:[]};a=c=null;this.uiDataGridTbody.data("rowselected",b([]));this._totalPages=this._offset=this._num_rows=0;this._createPagination();this._tbodyEvents()},_init:function(){this.options.autoRender&&this.render()},_setOption:function(a,
c){"jsonStore"===a&&b.isPlainObject(c)?this.options.jsonStore=b.extend({},this.options.jsonStore,c):1.9<=p?this._super(a,c):b.Widget.prototype._setOption.apply(this,arguments)},_destroy:function(){1.9>p&&b.Widget.prototype.destroy.call(this);b.isFunction(this.options.onClickRow)&&this.uiDataGridTbody.off();b.isArray(this.options.toolBarButtons)&&b(this.uiDataGridTfoot[0].rows[0].cells).find("button.ui-button").off();!0===this.options.pagination&&b(this.uiDataGridTfoot[0].rows[0].cells).last().off();
this.element.empty()},_createColumns:function(){var a=this,c=null,d=[],e=[],f=null,m=0,k=0,n="<col></col>",l='<th class="ui-widget ui-state-default" role="columnheader"></th>',g="ui-datagrid-align-";b.map(a.options.mapper,function(a,s){f=a.title||a.name;m=10;c=b(l).html(f);c=c.text(c.text());/left|right|center/.test(a.align)?b(c[0]).data("text-align",g+a.align).addClass(g+a.align):b(c[0]).data("text-align",g+"left").addClass(g+"left");h!==a.width&&(m=a.width);e[e.length]=b(n).width(m)[0];d[d.length]=
c[0];h!==a.hidden&&(b(c[0]).data("hidden","ui-datagrid-column-hide").addClass("ui-datagrid-column-hide"),b(e).last().addClass("ui-datagrid-column-hide"));k+=m});a.options.rowNumber&&(e.splice(0,0,b(n).width(20)[0]),d.splice(0,0,b('<th class="ui-state-default ui-datagrid-cell-rownumber" role="columnheader"><div></div></th>')[0]),k+=20);k>a.element.width()&&a.uiDataGridScrollMain.width(k);b([a.uiDataGridColGroup1[0],a.uiDataGridColGroup2[0]]).empty().append(e.slice(0,-1));b([a.uiDataGridThead[0].rows[0],
a.uiDataGridTheadBody[0].rows[0]]).empty().append(d);b(a.uiDataGridThead[0].rows[0].cells).slice(0,-1).map(function(c,d){d=b(d).outerWidth();a.uiDataGridColGroup1.children().eq(c).width(d);a.uiDataGridColGroup2.children().eq(c).width(d)});b(a.uiDataGridTbody[0].parentNode).map(function(c,d){c=b(d.parentNode).find(".ui-datagrid-gridlayout");0<c.length&&c.remove();d=b(d).clone().addClass("ui-datagrid-gridlayout").find("tbody").append('<tr><td class="ui-widget ui-widget-content">&nbsp;'+Array(d.tHead.rows[0].cells.length).join('</td><td class="ui-widget ui-widget-content">&nbsp;')+
"</td></tr>").end().appendTo(d.parentNode);b(d[0].tHead).remove();a.options.rowNumber&&(d[0].tBodies[0].rows[0].cells[0].className="ui-state-default ui-datagrid-cell-rownumber")});b(a.uiDataGridTheadBody[0].parentNode.tHead).hide();d=c=a=n=e=l=g=null},_createRows:function(a,c,d){var e=this,f=e.getThead()[0].rows[0].cells,m=d?e.uiDataGridTbody[0]:e.uiDataGridTbody.empty()[0],k=d?m.rows.length+1:e._offset+1,n=!d&&"local"===c&&e.options.pagination,l,g;0===e._num_rows&&(e._num_rows=h===a.num_rows?h===
a.rows?h===a[0].num_rows?a.length:a[0].num_rows:h===a.rows[0].num_rows?a.rows.length:a.rows[0].num_rows:a.num_rows);a=a.rows||a;n&&1<k&&(a=a.slice(e._offset));b.map(a,function(a,d){if(n&&d===e.options.limit)return!1;l=m.insertRow(-1);l.className="ui-state-hover";b(l).data("row-json",a);e.options.rowNumber&&b(l.insertCell(0)).addClass("ui-state-default ui-datagrid-cell-rownumber").html("<div>"+(k+d)+"</div>");b.map(e.options.mapper,function(d,c){g=l.insertCell(-1);g.className="ui-widget ui-widget-content";
b.map(b(f[g.cellIndex]).data(),function(a,b){/textAlign|text-align|hidden/.test(b)&&(g.className+=" "+a)});b(g).html(b.isFunction(d.render)?d.render.call(g,a[d.name]):a[d.name])})});d||(this._updatePagination(),e.uiDataGridScrollBody.scrollTop(0));f=m=l=g=e=a=null},_createPagination:function(){if(!0===this.options.pagination){var a=this,c=b(this.uiDataGridTfoot[0].rows[0].cells).last()[0];a.uiDataGridTdPagination.childs.push(b(c).children()[0]);b.map(["first","prev","next","end"],function(d,e){e=
b("<button></button>").attr({name:"data-grid-button-"+d,type:"button"}).text(d).button({icons:{primary:"ui-icon-seek-"+d},text:!1,disabled:!0}).appendTo(c);a.uiDataGridTdPagination.childs.push(e[0])});b(c).off().on("click.uiDataGridPagination","button.ui-button",function(a){return function(c){c.preventDefault();c.stopPropagation();!1===this.disabled&&(c=["_",this.name.replace(/data-grid-button-/,""),"Page"],b(a.uiDataGridTdPagination.childs).filter("button").removeClass("ui-state-hover ui-state-focus").button("disable"),
a[c.join("")](),a.load());return!1}}(a));c.style.visibility="visible";a=c=null}},_updatePagination:function(){var a,c;this.options.pagination&&this._num_rows&&(this._totalPages=Math.ceil(this._num_rows/this.options.limit),a=0===this._offset?1:this._offset/this.options.limit+1,c=a+" de "+this._totalPages+" ("+this._num_rows+")",function(d){b.map(d.uiDataGridTdPagination.childs,function(e){/span/i.test(e.tagName)?b(e).text(c):/data-grid-button-(first|prev)/.test(e.name)?0<d._offset&&e.disabled&&b(e).button("enable"):
d._totalPages>a&&e.disabled&&b(e).button("enable")})}(this))},_createToolBarButtons:function(){if(b.isArray(this.options.toolBarButtons)){var a=this,c=this.uiDataGridTfoot[0].rows[0].cells[0];b(c).off().on("click.uiDataGridButtonCallback","button.ui-button",function(a){a.preventDefault();a.stopPropagation();var c=b(this).data();b.isFunction(c.uiDataGridToolBarButtonsClick)&&c.uiDataGridToolBarButtonsClick.call(c.uiDataGridElement,a)});b.map(a.options.toolBarButtons,function(d,e){var f=b("<button></button>",
{type:"button"}).data("uiDataGridElement",a.element[0]);d.text=d.label||d.text;d.click=d.fn||d.click;delete d.fn;delete d.label;b.isFunction(d.click)&&f.data("uiDataGridToolBarButtonsClick",d.click);f.text(d.text).button({icons:{primary:h===d.icon?null:"ui-icon-"+d.icon}}).appendTo(c)});c=a=null}},_tbodyEvents:function(){if(b.isFunction(this.options.onClickRow))this.uiDataGridTbody.off().on("click.uiDataGridTbody","tr.ui-state-hover",function(a){return function(c){b(this).addClass("ui-state-highlight");
a.options.onClickRow.call(a.element[0],this,c);var d=a.uiDataGridTbody[0],e=b(d).data("rowselected");c.currentTarget!==e[0]&&e.removeClass("ui-state-highlight");b(d).data("rowselected",b(c.currentTarget))}}(this))},_nextPage:function(){this._offset+=this.options.limit},_prevPage:function(){this._offset-=this.options.limit},_endPage:function(){this._offset=this._totalPages*this.options.limit-this.options.limit},_firstPage:function(){this._offset=0},_active:function(){return this.element.children(":eq(0)").hasClass("ui-datagrid-container")},
_getBHF:function(a,c){return b.isFunction(c)?c.call(a[0]):a},_message:function(a){b('<tr><td class="ui-widget ui-datagrid-align-center ui-state-error" colspan="1000">'+a+"</td></tr>").appendTo(this.uiDataGridTbody.empty()[0])},_ajax:function(){var a=this.options,c=a.jsonStore.url,d=a.limit,e=this._offset,f=a.jsonStore;h===c||""===c?(c=(f.data.rows||f.data)[0],h===c||h===c[a.mapper[0].name]?this._message("Invalid JSON or empty data"):this._createRows(f.data,"local"),c=null):("string"===typeof f.params?
f.params=0===e?f.params+"&limit="+d+"&offset="+e:f.params.replace(/(&offset=)(.+)/,"&offset="+e):(h===f.params&&(f.params={}),f.params.limit=d,f.params.offset=e),b.ajax({type:a.ajaxMethod.toLowerCase(),url:c.replace(/\?.*/,""),data:f.params,dataType:"json",context:this,success:function(a){if(h!==a.error||0===a.length)return a=h!==a.error?a.error:0===a.length?this.options.emptyDataMessage:"Invalid JSON",b.isFunction(this.options.onError)?this.options.onError.call(this.element[0],a):this._message(a),
!1;this._createRows(a,"ajax");b.isFunction(this.options.onAjaxSuccess)&&this.options.onAjaxSuccess.call(this.element[0])}}))},render:function(){var a=this,c=0;a._active()?(a.resetOffset(),a.load()):(a._createToolBarButtons(),a.uiDataGrid.appendTo(a.element),a._createColumns(),a.resize(),a.options.autoLoad&&(c=180,setTimeout(function(a){return function(){a.load()}}(a),c)),b.isFunction(a.options.onComplete)&&setTimeout(function(a){return function(){a.options.onComplete.call(a.element[0])}}(a),c+1));
a=null},resize:function(){this.options.fit&&function(a){a=a.uiDataGrid.outerHeight()-a.element.height();this.style.height=b(this).height()-a+"px"}.call(this.uiDataGridScrollBody[0],this)},getSelectedRow:function(){return this.uiDataGridTbody.data("rowselected")},clearSelectedRow:function(){(function(){b(this).data("rowselected").removeClass("ui-state-highlight");b(this).data("rowselected",b([]))}).call(this.uiDataGridTbody[0])},load:function(){this._ajax()},widget:function(){return this.uiDataGrid},
getOffset:function(){return this._offset},resetOffset:function(){this._offset=this._num_rows=0;!0===this.options.pagination&&b(this.uiDataGridTdPagination.childs).filter("button").button("disable")},getThead:function(a){return this._getBHF(this.uiDataGridThead,a)},getTbody:function(a){return this._getBHF(this.uiDataGridTbody,a)},getTFoot:function(a){return this._getBHF(this.uiDataGridTfoot,a)},addRow:function(a){this._createRows(a,null,!0)},loadLocalData:function(a,c){this.resetOffset();this.options.jsonStore=
{url:"",params:{},data:a};this.load();b.isFunction(c)&&c.call([])},updateColumns:function(a){this.options.mapper=a;this.uiDataGridTbody.empty();this._createColumns();this.resetOffset()}})})(jQuery,window,document);