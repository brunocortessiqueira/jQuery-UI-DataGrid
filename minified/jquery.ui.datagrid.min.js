/*!
 * jQuery UI datagrid
 * 
 * @autor:.....Juarez Gon√ßalves Nery Junior
 * @email:.....juareznjunior@gmail.com
 * @twitter:...@juareznjunior
 * 
 * Depends:
 *	 jquery.ui.core.js
 *	 jquery.ui.widget.js
 *	 jquery.ui.button.js
 */
;(function(b,n,m,i){b.widget("ui.datagrid",{options:{limit:20,mapper:[],height:200,jsonStore:{params:{},url:"",data:{}},pagination:!0,refresh:!1,rowNumber:!1,fit:!1,autoRender:!0,autoLoad:!0,ajaxMethod:"GET",title:"",onClickRow:!1,onComplete:!1,onError:!1,toolBarButtons:!1},_create:function(){var a=[],c;this.uiDataGrid=b('<div class="ui-datagrid-container ui-widget ui-widget-content ui-corner-all"><div class="ui-state-default ui-datagrid-title"><div class="ui-widget-header"></div></div><div class="ui-datagrid-content"><div class="ui-datagrid-content-scroll"><div class="ui-datagrid-header ui-state-default"><table><thead><tr><th><table class="ui-datagrid"><colgroup></colgroup><thead><tr role="rowheader"></tr></thead></table></th><th></th></tr></thead></table></div><div class="ui-widget-content ui-datagrid-body"><table class="ui-datagrid"><colgroup></colgroup><thead><tr role="rowheader"></tr></thead><tbody></tbody></table></div></div></div><div class="ui-widget ui-state-default ui-datagrid-tools"><table class="ui-datagrid"><tbody><tr><td>&nbsp;</td><td style="visibility:hidden"><span></span></td></tr></tbody></table></div></div>');
this.uiDataGrid.find("table").filter(function(){b(this).hasClass("ui-datagrid")?a.push(this):c=this.parentNode.parentNode});""===this.options.title?b(c.parentNode).prev().remove():b(c.parentNode).prev().children().text(this.options.title);!1===b.isArray(this.options.toolBarButtons)&&!1===this.options.pagination&&b(a[2].parentNode).remove();this.uiDataGridThead=b(a[0].tHead);this.uiDataGridTheadBody=b(a[1].tHead);this.uiDataGridColGroup1=this.uiDataGridThead.prev();this.uiDataGridColGroup2=this.uiDataGridTheadBody.prev();
this.uiDataGridTbody=b(a[1].tBodies[0]);this.uiDataGridTfoot=this.options.pagination||b.isArray(this.options.toolBarButtons)?b(a[2].tBodies[0]):b([]);this.uiDataGridScrollBody=b(a[1].parentNode).height(this.options.height);this.uiDataGridScrollMain=b(c);this.uiDataGridTdPagination={td:[],childs:[]};a=c=null;b.data(this.uiDataGridTbody[0],"rowselected",b([]));!0===this.options.pagination&&this._createPageButtons();this._totalPages=this._offset=0;this._tbodyEvents()},_init:function(){this.options.autoRender&&
this.render()},_setOption:function(a,c){"jsonStore"===a&&b.isPlainObject(c)?this.options.jsonStore=b.extend({},this.options.jsonStore,c):b.Widget.prototype._setOption.apply(this,arguments)},_createPageButtons:function(){var a=this,c=b(a.uiDataGridTfoot[0].rows[0].cells).last()[0];a.uiDataGridTdPagination.td=c;a.uiDataGridTdPagination.childs.push(b(c).children()[0]);b.map(["first","prev","next","end"],function(d,e){e=m.createElement("button");e.name="data-grid-button-"+d;e.innerHTML=d;b(e).button({icons:{primary:"ui-icon-seek-"+
d},text:!1,disabled:!0}).appendTo(c);a.uiDataGridTdPagination.childs.push(e)});b(c).on("click","button",function(a){return function(){if(!1===this.disabled){var c=["_",this.name.replace(/data-grid-button-/,""),"Page"];b(a.uiDataGridTdPagination.childs).filter("button").removeClass("ui-state-hover ui-state-focus").button("disable");a[c.join("")]();a.load()}}}(a));c=a=null},_managePagination:function(a){var c=this,d,e;c.options.pagination&&a&&(c._totalPages=Math.ceil(a/c.options.limit),d=0==c._offset?
1:c._offset/c.options.limit+1,e=d+" de "+c._totalPages+" ("+a+")",this.uiDataGridTdPagination.td.style.visibility="visible",b.each(this.uiDataGridTdPagination.childs,function(){/span/i.test(this.tagName)?this.innerHTML=e:/data-grid-button-(first|prev)/.test(this.name)?0<c._offset&&this.disabled&&b(this).button("enable"):c._totalPages>d&&this.disabled&&b(this).button("enable")}));c=null},_createColumns:function(){var a=this,c,d=[],e='<div class="ui-widget ui-state-default" style="overflow:scroll;position:absolute;left:0"></div>',
f="<col></col>",h=[],g='<th class="ui-widget ui-state-default" role="columnheader"></th>',l,j=0,k=0;b.map(a.options.mapper,function(a){l=a.title||a.name;j=10;c=b(g).text(l);/left|right|center/.test(a.align)&&(c[0].style.textAlign=a.align);i!==a.width&&(j=a.width);a=b(e).text(l).appendTo(m.body);j=Math.max(j,a.innerWidth());a.remove();h[h.length]=b(f).width(j)[0];d[d.length]=c[0];k+=j});a.options.rowNumber&&(h.splice(0,0,b(f).width(20)[0]),d.splice(0,0,b('<th class="ui-state-default ui-datagrid-cell-rownumber" role="columnheader"><div></div></th>')[0]),
k+=20);k>a.element.width()&&a.uiDataGridScrollMain.width(k);b(h).last().width("auto");b([a.uiDataGridColGroup1[0],a.uiDataGridColGroup2[0]]).append(h);b([a.uiDataGridThead[0].rows[0],a.uiDataGridTheadBody[0].rows[0]]).append(d);d=c=a=f=h=e=g=null},_createRows:function(a,c){var d=this,e=d.getThead()[0].rows[0].cells,f=d.uiDataGridTbody.empty()[0],h,g,l=d._offset+1,j="local"===c&&d.options.pagination,k=i===a.num_rows?i===a.rows?i===a[0].num_rows?a.length:a[0].num_rows:i===a.rows[0].num_rows?a.rows.length:
a.rows[0].num_rows:a.num_rows,a=a.rows||a;j&&1<l&&(a=a.slice(d._offset));d._managePagination(k);d.uiDataGridScrollBody.scrollTop(0);b.each(a,function(a,c){if(j&&a===d.options.limit)return!1;h=f.insertRow(-1);h.className="ui-state-hover";d.options.rowNumber&&(g=h.insertCell(0),g.className="ui-state-default ui-datagrid-cell-rownumber",g.innerHTML="<div>"+(l+a)+"</div>");b.map(d.options.mapper,function(a){g=h.insertCell(-1);g.className="ui-widget ui-widget-content";g.style.cssText="text-align:"+e[g.cellIndex].style.textAlign;
b(g).html(b.isFunction(a.render)?a.render.call(g,c[a.name],c):c[a.name])})});e=f=h=g=d=a=null},_ajax:function(){var a=this.options,c=a.jsonStore.url,d=a.limit,e=this._offset,f=a.jsonStore;i===c||""===c?this._createRows(f.data,"local"):("string"===typeof f.params?f.params=0===e?f.params+"&limit="+d+"&offset="+e:f.params.replace(/(&offset=)(.+)/,"&offset="+e):(i===f.params&&(f.params={}),f.params.limit=d,f.params.offset=e),b.ajax({type:a.ajaxMethod.toLowerCase(),url:c.replace(/\?.*/,""),data:f.params,
dataType:"json",context:this,success:function(a){if(i!=a.error||0===a.length){b.isFunction(this.options.onError)?this.options.onError.call(this.element[0]):alert(0===this.length?"Empty rows":this.error);return false}this._createRows(a,"ajax")}}))},render:function(){var a=this,c,d;a._active()?(a.resetOffset(),a.load()):(b.isArray(a.options.toolBarButtons)&&(c=a.uiDataGridTfoot[0].rows[0].cells[0],b.map(a.options.toolBarButtons,function(d){(function(a){if(b.isFunction(d.fn))this.on("click",function(){d.fn.apply(a.element[0],
arguments);b(this).blur()});this.button({icons:{primary:i===d.icon?null:"ui-icon-"+d.icon}});c.appendChild(this[0])}).call(b(m.createElement("button")).html(d.label),a)}),c=null),"none"===a.element.css("display")&&a.element.show(),a.uiDataGrid.appendTo(a.element),a._createColumns(),d=a.uiDataGridThead.outerHeight(),a.uiDataGridTheadBody.parent().css("marginTop",-d),d=null,a.resize(),a.options.autoLoad&&a.load(),b.isFunction(a.options.onComplete)&&function(a){setTimeout(function(){a.options.onComplete.call(a.element[0])})}(a));
a=null;return this},_nextPage:function(){this._offset+=this.options.limit},_prevPage:function(){this._offset-=this.options.limit},_endPage:function(){this._offset=this._totalPages*this.options.limit-this.options.limit},_firstPage:function(){this._offset=0},_tbodyEvents:function(){if(b.isFunction(this.options.onClickRow))this.uiDataGridTbody.off().on("click","tr",function(a){return function(c){b(this).addClass("ui-state-highlight");a.options.onClickRow.call(a,this);var d=a.uiDataGridTbody[0],e=b.data(d,
"rowselected");c.currentTarget!==e[0]&&e.removeClass("ui-state-highlight");b.data(d,"rowselected",b(c.currentTarget))}}(this));return this},_active:function(){return this.element.children(":eq(0)").hasClass("ui-datagrid-container")},_getBHF:function(a,c){return b.isFunction(c)?c.call(a[0]):a},resize:function(){this.options.fit&&function(a){a=a.uiDataGrid.outerHeight()-a.element.height();this.style.height=b(this).height()-a+"px"}.call(this.uiDataGridScrollBody[0],this);return this},getSelectedRow:function(){return b.data(this.uiDataGridTbody[0],
"rowselected")},clearSelectedRow:function(){(function(){b.data(this,"rowselected").removeClass("ui-state-highlight");b.data(this,"rowselected",b([]))}).call(this.uiDataGridTbody[0])},load:function(){this._ajax();return this},widget:function(){return this.uiDataGrid},destroy:function(){b.Widget.prototype.destroy.call(this);this.element.empty()},getOffset:function(){return this._offset},resetOffset:function(){this._offset=0},getThead:function(a){return this._getBHF(this.uiDataGridThead,a)},getTbody:function(a){return this._getBHF(this.uiDataGridTbody,
a)},getTFoot:function(a){return this._getBHF(this.uiDataGridTfoot,a)}})})(jQuery,window,document);