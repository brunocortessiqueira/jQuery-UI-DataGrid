/*!
 * jQuery UI datagrid
 * 
 * @autor:.....Juarez Gon?alves Nery Junior
 * @email:.....juareznjunior@gmail.com
 * @twitter:...@juareznjunior
 * 
 * Depends:
 *	 jquery.ui.core.js
 *	 jquery.ui.widget.js
 *	 jquery.ui.button.js
 */
(function(b){b.widget("ui.datagrid",{options:{limit:5,mapper:[],height:200,jsonStore:{params:{},url:"",data:{}},pagination:true,refresh:false,rowNumber:false,fit:false,autoRender:true,autoLoad:true,ajaxMethod:"GET",title:"",onClickRow:false,onComplete:false,toolBarButtons:false},_create:function(){this.uiDataGrid=b(this._getMarkup());this.uiDataGridTables=this.uiDataGrid.find("table.ui-datagrid");this.uiDataGridThead=b(this.uiDataGridTables[0].tHead);this.uiDataGridColGroup=this.uiDataGridThead.prev();
this.uiDataGridTheadBody=b(this.uiDataGridTables[1].tHead);this.uiDataGridTbody=b(this.uiDataGridTables[1].tBodies[0]);this.uiDataGridTfoot=this.options.pagination||b.isArray(this.options.toolBarButtons)?b(this.uiDataGridTables[2].tBodies[0]):b([]);this.uiDataGridScroll=b(this.uiDataGridTables[1].parentNode).height(this.options.height);b.data(this.uiDataGridTbody[0],"rowselected",b([]));this._totalPages=this._offset=0;this._selectedRows=[];this._tbodyEvents();this.uiDataGridTables=this.uiDataGridChilds=
null},_init:function(){this.options.autoRender&&this.render()},_setOption:function(a,c){b.Widget.prototype._setOption.apply(this,arguments)},_getMarkup:function(){var a=document.createElement("div"),c="",d="<caption></caption>";a.className="ui-datagrid-container ui-widget ui-widget-content ui-corner-all";this.options.title!=""&&(d='<caption class="ui-state-default"><div class="ui-widget-header">'+this.options.title+"</div></caption>");c+='<div class="ui-datagrid-header ui-state-default"><table>'+
d+'<thead><tr><th><table class="ui-datagrid"><colgroup></colgroup><thead><tr></tr></thead></table></th><th style="width:17px"></th></tr></thead></table></div><div class="ui-datagrid-body"><table class="ui-datagrid"><thead><tr></tr></thead><tbody></tbody></table></div>';if(this.options.pagination||b.isArray(this.options.toolBarButtons))c+='<div class="ui-widget ui-state-default ui-datagrid-tools"><table cellspacing="0" cellpadding="0" class="ui-datagrid"><tbody><tr><td>&nbsp;</td>',this.options.pagination&&
(c+="<td><span></span></td>"),c+="</tr></tbody></table></div>";c+="</div>";a.innerHTML=c;return a},_createToolButtons:function(){for(var a=[],c=["first","prev","next","end"],d,e,f=0;e=c[f++];)d=document.createElement("button"),d.name="data-grid-button-"+e,d.innerHTML=e,b(d).button({icons:{primary:"ui-icon-seek-"+e},text:false}),a[a.length]=d;b(a).appendTo(b(this.uiDataGridTfoot[0].rows[0].cells).eq(-1)[0]);return this},_disableToolButtons:function(){b(this.uiDataGridTfoot[0].rows[0].cells).eq(-1).children(":button").removeClass("ui-state-hover ui-state-focus").button("disable");
return this},_createColumns:function(){for(var a={width:10},c,d=[],e,f=0;e=this.options.mapper[f++];){c=document.createElement("th");c.className="ui-widget ui-state-default";var g=void 0!==e.title?e.title:e.name,h=b(document.createElement("div")).addClass("ui-widget ui-state-default").css({overflow:"scroll",position:"absolute",left:0}).html(g).appendTo(document.body);b(c).attr("role","gridcell")[0].innerHTML=g;if(void 0!==e.align&&/left|right|center/.test(e.align))c.style.textAlign=e.align;if(void 0!==
e.width)a.width=e.width;a.width=Math.max(a.width,h[0].scrollWidth);b(document.createElement("col")).css(a).appendTo(this.uiDataGridColGroup[0]);document.body.removeChild(h[0]);d[d.length]=c}this.uiDataGridColGroup.children().eq(-1).css("width","auto");if(this.options.rowNumber)c=document.createElement("th"),c.className="ui-state-default ui-datagrid-cell-rownumber",c.innerHTML="<div></div>",b(document.createElement("col")).width(20).prependTo(this.uiDataGridColGroup[0]),d.splice(0,0,c);this.uiDataGridColGroup.clone().insertBefore(this.uiDataGridTheadBody[0]);
b([this.uiDataGridThead[0].rows[0],this.uiDataGridTheadBody[0].rows[0]]).append(d)},_createRows:function(a){var c=this.getThead()[0].rows[0].cells;this.uiDataGridTbody.empty();this.uiDataGridScroll.scrollTop(0);for(var d,e,f,g=0,h=0;f=a.rows[g++];){d=document.createElement("tr");d.className="ui-state-hover";if(this.options.rowNumber)e=document.createElement("td"),e.className="ui-state-default ui-datagrid-cell-rownumber",e.innerHTML="<div>"+(parseInt(this._offset)+g)+"</div>",d.appendChild(e);for(;_td=
this.options.mapper[h++];)e=document.createElement("td"),e.className="ui-widget ui-widget-content",d.appendChild(e),e.style.cssText="text-align:"+c[e.cellIndex].style.textAlign,void 0!=_td.css&&_td.css.hasOwnProperty("textAlign")&&b(e).css("textAlign",_td.css.textAlign),e.innerHTML=b.isFunction(_td.render)?_td.render(f[_td.name]):b.isFunction(window[_td.globalFunction])?window[_td.globalFunction](f[_td.name]):f[_td.name];d.appendChild(document.createElement("th"));this.uiDataGridTbody[0].appendChild(d);
h=0}y=0},_ajax:function(){var a=this;a.options.jsonStore.url!=""?("string"===typeof a.options.jsonStore.params?a.options.jsonStore.params=0===a._offset?a.options.jsonStore.params+"&limit="+a.options.limit+"&offset="+a._offset:a.options.jsonStore.params.replace(/(&offset=)(.+)/,"&offset="+a._offset):(a.options.jsonStore.params.limit=a.options.limit,a.options.jsonStore.params.offset=a._offset),a.options.pagination&&a._disableToolButtons(),b.ajax({type:a.options.ajaxMethod.toLowerCase(),url:a.options.jsonStore.url.replace(/\?.*/,
""),data:a.options.jsonStore.params,dataType:"json",success:function(c){if(void 0!=c.error)alert(c.error);else{if(void 0===c.num_rows||c.num_rows==0)return false;if(a.options.pagination){a._totalPages=Math.ceil(c.num_rows/a.options.limit);var d=a._offset==0?1:a._offset/a.options.limit+1,e=d+" de "+a._totalPages+" ("+c.num_rows+")";b.each(b(a.uiDataGridTfoot[0].rows[0].cells).eq(-1).children(),function(){/span/i.test(this.tagName)?this.innerHTML=e:/data-grid-button-(first|prev)/.test(this.name)?a._offset>
0&&this.disabled&&b(this).button("enable"):a._totalPages>d&&this.disabled&&b(this).button("enable")})}a._createRows(c)}}})):a._createRows(a.options.jsonStore.data)},render:function(){var a=this;if(a._active())a.resetOffset(),a.load();else{if(b.isArray(a.options.toolBarButtons)){var c=a.uiDataGridTfoot[0].rows[0].cells[0];b.each(a.options.toolBarButtons,function(e,d){(function(){b.isFunction(d.fn)&&this.bind("click",function(){d.fn.apply(a.element[0],arguments);b(this).blur()});this.button({icons:{primary:void 0===
d.icon?null:"ui-icon-"+d.icon}});c.appendChild(this[0])}).call(b(document.createElement("button")).html(d.label),a)});c=null}a.uiDataGrid.appendTo(a.element);a._createColumns();var d=a.uiDataGridThead.outerHeight();a.uiDataGridTheadBody.parent().css("marginTop",-d);d=null;a.options.pagination&&(a._createToolButtons()._disableToolButtons(),b(a.uiDataGridTfoot[0].rows[0].cells).eq(-1).delegate("button","click",function(){if(!this.disabled)a[this.name.replace(/data-grid-button-/,"")+"Page"](),a._selectedRows=
[],a.load()}));a.resize();a.options.autoLoad&&a.load();b.isFunction(a.options.onComplete)&&a.options.onComplete.call(a.uiDataGridTbody[0])}return this},nextPage:function(){this._offset+=this.options.limit},prevPage:function(){this._offset-=this.options.limit},endPage:function(){this._offset=this._totalPages*this.options.limit-this.options.limit},firstPage:function(){this._offset=0},_tbodyEvents:function(){if(b.isFunction(this.options.onClickRow)){var a=this.uiDataGridTbody;b.data(a[0],"callback",
this.options.onClickRow);a.undelegate().delegate("tr","click",function(){var a=this.parentNode;b(this).addClass("ui-state-highlight");b.data(a,"callback").call(this);(function(a){a!==this[0]&&this.removeClass("ui-state-highlight")}).call(b.data(a,"rowselected"),this);b.data(a,"rowselected",b(this));a=null});a=null}return this},_active:function(){return this.element.children(":eq(0)").hasClass("ui-datagrid-container")},resize:function(){this.options.fit&&function(a){a=a.uiDataGrid.outerHeight()-a.element.height();
this.style.height=b(this).height()-a+"px"}.call(this.uiDataGridScroll[0],this);return this},getSelectedRow:function(){return b.data(this.uiDataGridTbody[0],"rowselected")},clearSelectedRow:function(){(function(){b.data(this,"rowselected").removeClass("ui-state-highlight");b.data(this,"rowselected",b([]))}).call(this.uiDataGridTbody[0])},load:function(){this._ajax();return this},widget:function(){return this.uiDataGrid},destroy:function(){b.Widget.prototype.destroy.call(this);this.element.empty()},
getOffset:function(){return this._offset},resetOffset:function(){this._offset=0},getThead:function(a){return b.isFunction(a)?a.call(this.uiDataGridThead[0]):this.uiDataGridThead},getTbody:function(a){return b.isFunction(a)?a.call(this.uiDataGridTbody[0]):this.uiDataGridTbody},getTFoot:function(a){return b.isFunction(a)?a.call(this.uiDataGridTfoot[0]):this.uiDataGridTfoot}})})(jQuery);