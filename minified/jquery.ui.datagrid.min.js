/*!
 * jQuery UI datagrid
 * 
 * @autor:.....Juarez Gon√ßalves Nery Junior
 * @email:.....juareznjunior@gmail.com
 * @twitter:...@juareznjunior
 * 
 * Depends:
 *	 jquery.ui.core.js
 *	 jquery.ui.widget.js
 *	 jquery.ui.button.js
 */
;(function(b,l,f,h){b.widget("ui.datagrid",{options:{limit:20,mapper:[],height:200,jsonStore:{params:{},url:"",data:{}},pagination:!0,refresh:!1,rowNumber:!1,fit:!1,autoRender:!0,autoLoad:!0,ajaxMethod:"GET",title:"",onClickRow:!1,onComplete:!1,onError:!1,toolBarButtons:!1},_create:function(){var a=[],c;this.uiDataGrid=b(this._getTemplate());this.uiDataGrid.find("table").filter(function(){b(this).hasClass("ui-datagrid")?a.push(this):c=this.createCaption()});""===this.options.title?c.parentNode.deleteCaption():
b(c).children().text(this.options.title);!1===b.isArray(this.options.toolBarButtons)&&!1===this.options.pagination&&b(a[2].parentNode).remove();this.uiDataGridThead=b(a[0].tHead);this.uiDataGridColGroup=this.uiDataGridThead.prev();this.uiDataGridTheadBody=b(a[1].tHead);this.uiDataGridTbody=b(a[1].tBodies[0]);this.uiDataGridTfoot=this.options.pagination||b.isArray(this.options.toolBarButtons)?b(a[2].tBodies[0]):b([]);this.uiDataGridScroll=b(a[1].parentNode).height(this.options.height);a=c=null;b.data(this.uiDataGridTbody[0],
"rowselected",b([]));this._totalPages=this._offset=0;this._tbodyEvents()},_init:function(){this.options.autoRender&&this.render()},_setOption:function(a,c){"jsonStore"===a&&b.isPlainObject(c)?this.options.jsonStore=b.extend({},this.options.jsonStore,c):b.Widget.prototype._setOption.apply(this,arguments)},_getTemplate:function(){return'<div class="ui-datagrid-container ui-widget ui-widget-content ui-corner-all"><div class="ui-datagrid-header ui-state-default"><table><caption class="ui-state-default"><div class="ui-widget-header"></div></caption><thead><tr><th><table class="ui-datagrid"><colgroup></colgroup><thead><tr></tr></thead></table></th><th></th></tr></thead></table></div><div class="ui-widget-content ui-datagrid-body"><table class="ui-datagrid"><thead><tr></tr></thead><tbody></tbody></table></div><div class="ui-widget ui-state-default ui-datagrid-tools"><table class="ui-datagrid"><tbody><tr><td>&nbsp;</td><td><span></span></td></tr></tbody></table></div></div>'},
_createPageButtons:function(){var a=b(this.uiDataGridTfoot[0].rows[0].cells).eq(-1)[0];b.map(["first","prev","next","end"],function(c,d){d=f.createElement("button");d.name="data-grid-button-"+c;d.innerHTML=c;b(d).button({icons:{primary:"ui-icon-seek-"+c},text:!1}).appendTo(a)});a=null;return this},_disablePageButtons:function(){b(this.uiDataGridTfoot[0].rows[0].cells).eq(-1).children(":button").removeClass("ui-state-hover ui-state-focus").button("disable");return this},_createColumns:function(){var a=
this,c,d=[];b.map(a.options.mapper,function(b){c=f.createElement("th");c.className="ui-widget ui-state-default";var g=b.title||b.name,e=f.createElement("div"),k=f.createElement("col"),j=10;c.innerHTML=g;e.className="ui-widget ui-state-default";e.style.cssText="overflow:scroll;position:absolute;left:0";e.innerHTML=g;f.body.appendChild(e);/left|right|center/.test(b.align)&&(c.style.textAlign=b.align);h!==b.width&&(j=b.width);j=Math.max(j,e.scrollWidth);k.style.width=j+"px";a.uiDataGridColGroup[0].appendChild(k);
d[d.length]=c;f.body.removeChild(e)});a.uiDataGridColGroup.children().eq(-1)[0].style.width="auto";a.options.rowNumber&&(c=f.createElement("th"),c.className="ui-state-default ui-datagrid-cell-rownumber",c.innerHTML="<div></div>",b(f.createElement("col")).width(20).prependTo(a.uiDataGridColGroup[0]),d.splice(0,0,c));a.uiDataGridColGroup.clone().insertBefore(a.uiDataGridTheadBody[0]);b([a.uiDataGridThead[0].rows[0],a.uiDataGridTheadBody[0].rows[0]]).append(d);d=c=a=null},_createRows:function(a){var c=
this,d=c.getThead()[0].rows[0].cells,i=c.uiDataGridTbody.empty()[0],g,e,f=c._offset+1;c.uiDataGridScroll.scrollTop(0);b.map(a.rows||a,function(a,h){g=i.insertRow(-1);g.className="ui-state-hover";c.options.rowNumber&&(e=g.insertCell(0),e.className="ui-state-default ui-datagrid-cell-rownumber",e.innerHTML="<div>"+(f+h)+"</div>");b.map(c.options.mapper,function(c){e=g.insertCell(-1);e.className="ui-widget ui-widget-content";e.style.cssText="text-align:"+d[e.cellIndex].style.textAlign;e.innerHTML=b.isFunction(c.render)?
c.render.call(e,a[c.name]):a[c.name]})});d=i=g=e=c=null},_ajax:function(){var a=this.options.jsonStore.url;h===a||""===a?this._createRows(this.options.jsonStore.data):("string"===typeof this.options.jsonStore.params?this.options.jsonStore.params=0===this._offset?this.options.jsonStore.params+"&limit="+this.options.limit+"&offset="+v._offset:this.options.jsonStore.params.replace(/(&offset=)(.+)/,"&offset="+this._offset):(h===this.options.jsonStore.params&&(this.options.jsonStore.params={}),this.options.jsonStore.params.limit=
this.options.limit,this.options.jsonStore.params.offset=this._offset),this.options.pagination&&this._disablePageButtons(),b.ajax({type:this.options.ajaxMethod.toLowerCase(),url:this.options.jsonStore.url.replace(/\?.*/,""),data:this.options.jsonStore.params,dataType:"json",context:this,success:function(a){var d=this,i=a.num_rows||a[0].num_rows;if(h!=a.error)return b.isFunction(d.options.onError)?d.options.onError.call(d.element[0]):alert(a.error),!1;if(d.options.pagination&&h!==i){d._totalPages=Math.ceil(i/
d.options.limit);var g=0==d._offset?1:d._offset/d.options.limit+1,e=g+" de "+d._totalPages+" ("+i+")";b.each(b(d.uiDataGridTfoot[0].rows[0].cells).eq(-1).children(),function(){/span/i.test(this.tagName)?this.innerHTML=e:/data-grid-button-(first|prev)/.test(this.name)?0<d._offset&&this.disabled&&b(this).button("enable"):d._totalPages>g&&this.disabled&&b(this).button("enable")})}d._createRows(a);d=null}}))},render:function(){var a=this;if(a._active())a.resetOffset(),a.load();else{if(b.isArray(a.options.toolBarButtons)){var c=
a.uiDataGridTfoot[0].rows[0].cells[0];b.map(a.options.toolBarButtons,function(d){(function(a){if(b.isFunction(d.fn))this.on("click",function(){d.fn.apply(a.element[0],arguments);b(this).blur()});this.button({icons:{primary:h===d.icon?null:"ui-icon-"+d.icon}});c.appendChild(this[0])}).call(b(f.createElement("button")).html(d.label),a)});c=null}"none"===a.element.css("display")&&a.element.show();a.uiDataGrid.appendTo(a.element);a._createColumns();var d=a.uiDataGridThead.outerHeight();a.uiDataGridTheadBody.parent().css("marginTop",
-d);d=null;a.options.pagination&&(a._createPageButtons()._disablePageButtons(),b(a.uiDataGridTfoot[0].rows[0].cells).eq(-1).on("click","button",function(a){return function(){if(!1===this.disabled){var b=["_",this.name.replace(/data-grid-button-/,""),"Page"];a[b.join("")]();a.load()}}}(a)));a.resize();a.options.autoLoad&&a.load();b.isFunction(a.options.onComplete)&&function(a){setTimeout(function(){a.options.onComplete.call(a.element[0])})}(a)}a=null;return this},_nextPage:function(){this._offset+=
this.options.limit},_prevPage:function(){this._offset-=this.options.limit},_endPage:function(){this._offset=this._totalPages*this.options.limit-this.options.limit},_firstPage:function(){this._offset=0},_tbodyEvents:function(){if(b.isFunction(this.options.onClickRow))this.uiDataGridTbody.off().on("click","tr",function(a){return function(c){b(this).addClass("ui-state-highlight");a.options.onClickRow.call(a,this);var d=a.uiDataGridTbody[0],f=b.data(d,"rowselected");c.currentTarget!==f[0]&&f.removeClass("ui-state-highlight");
b.data(d,"rowselected",b(c.currentTarget))}}(this));return this},_active:function(){return this.element.children(":eq(0)").hasClass("ui-datagrid-container")},resize:function(){this.options.fit&&function(a){a=a.uiDataGrid.outerHeight()-a.element.height();this.style.height=b(this).height()-a+"px"}.call(this.uiDataGridScroll[0],this);return this},getSelectedRow:function(){return b.data(this.uiDataGridTbody[0],"rowselected")},clearSelectedRow:function(){(function(){b.data(this,"rowselected").removeClass("ui-state-highlight");
b.data(this,"rowselected",b([]))}).call(this.uiDataGridTbody[0])},load:function(){this._ajax();return this},widget:function(){return this.uiDataGrid},destroy:function(){b.Widget.prototype.destroy.call(this);this.element.empty()},getOffset:function(){return this._offset},resetOffset:function(){this._offset=0},getThead:function(a){return b.isFunction(a)?a.call(this.uiDataGridThead[0]):this.uiDataGridThead},getTbody:function(a){return b.isFunction(a)?a.call(this.uiDataGridTbody[0]):this.uiDataGridTbody},
getTFoot:function(a){return b.isFunction(a)?a.call(this.uiDataGridTfoot[0]):this.uiDataGridTfoot}})})(jQuery,window,document);