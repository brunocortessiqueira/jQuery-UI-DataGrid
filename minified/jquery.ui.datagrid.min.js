/*!
 * jQuery UI datagrid
 * 
 * @autor:.....Juarez Gon√ßalves Nery Junior
 * @email:.....juareznjunior@gmail.com
 * @twitter:...@juareznjunior
 * 
 * Depends:
 *	 jquery.ui.core.js
 *	 jquery.ui.widget.js
 *	 jquery.ui.button.js
 */
;(function(c,m,n,h){c.widget("ui.datagrid",{options:{limit:20,mapper:[],height:200,jsonStore:{url:"",params:{},data:{}},pagination:!0,refresh:!1,rowNumber:!1,fit:!1,autoRender:!0,autoLoad:!0,ajaxMethod:"GET",title:"",onClickRow:!1,onComplete:!1,onError:!1,toolBarButtons:!1},_create:function(){"none"===this.element.css("display")&&this.element.show();var a=[],b;this.uiDataGrid=c('<div class="ui-datagrid-container ui-widget ui-widget-content ui-corner-all"><div class="ui-state-default ui-datagrid-title"><div class="ui-widget-header"></div></div><div class="ui-datagrid-content"><div class="ui-datagrid-content-scroll"><div class="ui-datagrid-header ui-state-default"><table><thead><tr><th><table class="ui-datagrid"><colgroup></colgroup><thead><tr role="rowheader"></tr></thead></table></th><th></th></tr></thead></table></div><div class="ui-widget-content ui-datagrid-body"><table class="ui-datagrid"><colgroup></colgroup><thead><tr role="rowheader"></tr></thead><tbody></tbody></table></div></div></div><div class="ui-widget ui-state-default ui-datagrid-tools"><table class="ui-datagrid"><tbody><tr><td>&nbsp;</td><td style="visibility:hidden"><span></span></td></tr></tbody></table></div></div>');
this.uiDataGrid.find("table").filter(function(){c(this).hasClass("ui-datagrid")?a.push(this):b=this.parentNode.parentNode}).end();""===this.options.title?c(b.parentNode).prev().remove():c(b.parentNode).prev().children().text(this.options.title);!1===c.isArray(this.options.toolBarButtons)&&!1===this.options.pagination&&c(a[2].parentNode).remove();this.uiDataGridThead=c(a[0].tHead);this.uiDataGridTheadBody=c(a[1].tHead);this.uiDataGridColGroup1=this.uiDataGridThead.prev();this.uiDataGridColGroup2=this.uiDataGridTheadBody.prev();
this.uiDataGridTbody=c(a[1].tBodies[0]);this.uiDataGridTfoot=this.options.pagination||c.isArray(this.options.toolBarButtons)?c(a[2].tBodies[0]):c([]);this.uiDataGridScrollBody=c(a[1].parentNode).height(this.options.height);this.uiDataGridScrollMain=c(b);this.uiDataGridTdPagination={td:[],childs:[]};a=b=null;c.data(this.uiDataGridTbody[0],"rowselected",c([]));!0===this.options.pagination&&this._createPageButtons();this._totalPages=this._offset=0;this._tbodyEvents()},_init:function(){this.options.autoRender&&
this.render()},_setOption:function(a,b){"jsonStore"===a&&c.isPlainObject(b)?this.options.jsonStore=c.extend({},this.options.jsonStore,b):c.Widget.prototype._setOption.apply(this,arguments)},_createPageButtons:function(){var a=this,b=c(a.uiDataGridTfoot[0].rows[0].cells).last()[0];a.uiDataGridTdPagination.td=b;a.uiDataGridTdPagination.childs.push(c(b).children()[0]);c.map(["first","prev","next","end"],function(e,d){d=c("<button>").attr("name","data-grid-button-"+e).text(e).button({icons:{primary:"ui-icon-seek-"+
e},text:!1,disabled:!0}).appendTo(b);a.uiDataGridTdPagination.childs.push(d[0])});c(b).on("click","button.ui-button",function(a){return function(b){b.preventDefault();b.stopPropagation();!1===this.disabled&&(b=["_",this.name.replace(/data-grid-button-/,""),"Page"],c(a.uiDataGridTdPagination.childs).filter("button").removeClass("ui-state-hover ui-state-focus").button("disable"),a[b.join("")](),a.load());return!1}}(a));b=a=null},_managePagination:function(a){var b=this,e,d;b.options.pagination&&a&&
(b._totalPages=Math.ceil(a/b.options.limit),e=0==b._offset?1:b._offset/b.options.limit+1,d=e+" de "+b._totalPages+" ("+a+")",this.uiDataGridTdPagination.td.style.visibility="visible",c.each(this.uiDataGridTdPagination.childs,function(){/span/i.test(this.tagName)?this.innerHTML=d:/data-grid-button-(first|prev)/.test(this.name)?0<b._offset&&this.disabled&&c(this).button("enable"):b._totalPages>e&&this.disabled&&c(this).button("enable")}));b=null},_createColumns:function(){var a=this,b=null,e=[],d=[],
f=null,j=0,g=0,i="<col></col>",k='<th class="ui-widget ui-state-default" role="columnheader"></th>';c.map(a.options.mapper,function(a){f=a.title||a.name;j=10;b=c(k).html(f);b=b.text(b.text());/left|right|center/.test(a.align)&&(b[0].style.textAlign=a.align);h!==a.width&&(j=a.width);d[d.length]=c(i).width(j)[0];e[e.length]=b[0];g+=j});a.options.rowNumber&&(d.splice(0,0,c(i).width(20)[0]),e.splice(0,0,c('<th class="ui-state-default ui-datagrid-cell-rownumber" role="columnheader"><div></div></th>')[0]),
g+=20);g>a.element.width()&&a.uiDataGridScrollMain.width(g);c([a.uiDataGridColGroup1[0],a.uiDataGridColGroup2[0]]).append(d.slice(0,-1));c([a.uiDataGridThead[0].rows[0],a.uiDataGridTheadBody[0].rows[0]]).append(e);c(a.uiDataGridThead[0].rows[0].cells).slice(0,-1).map(function(b,d){d=c(d).outerWidth();a.uiDataGridColGroup1.children().eq(b).width(d);a.uiDataGridColGroup2.children().eq(b).width(d)});c(a.uiDataGridTbody[0].parentNode).map(function(b,d){d=c(d).clone().addClass("ui-datagrid-gridlayout").find("tbody").append('<tr><td class="ui-widget ui-widget-content">&nbsp;'+
Array(d.tHead.rows[0].cells.length).join('</td><td class="ui-widget ui-widget-content">&nbsp;')+"</td></tr>").end().appendTo(d.parentNode);c(d[0].tHead).remove();a.options.rowNumber&&(d[0].tBodies[0].rows[0].cells[0].className="ui-state-default ui-datagrid-cell-rownumber")});c(a.uiDataGridTheadBody[0].parentNode.tHead).hide();e=b=a=i=d=k=null},_createRows:function(a,b,e){var d=this,f=d.getThead()[0].rows[0].cells,j=e?d.uiDataGridTbody[0]:d.uiDataGridTbody.empty()[0],g,i,k=e?j.rows.length+1:d._offset+
1,l="local"===b&&d.options.pagination,b=h===a.num_rows?h===a.rows?h===a[0].num_rows?a.length:a[0].num_rows:h===a.rows[0].num_rows?a.rows.length:a.rows[0].num_rows:a.num_rows,a=a.rows||a;!e&&(l&&1<k)&&(a=a.slice(d._offset));e||(d._managePagination(b),d.uiDataGridScrollBody.scrollTop(0));c.each(a,function(a,b){if(!e&&l&&a===d.options.limit)return!1;g=j.insertRow(-1);g.className="ui-state-hover";c.data(g,"row-json",b);d.options.rowNumber&&c(g.insertCell(0)).addClass("ui-state-default ui-datagrid-cell-rownumber").html("<div>"+
(k+a)+"</div>");c.map(d.options.mapper,function(a){i=g.insertCell(-1);i.className="ui-widget ui-widget-content";i.style.cssText="text-align:"+f[i.cellIndex].style.textAlign;c(i).html(c.isFunction(a.render)?a.render.call(i,b[a.name]):b[a.name])})});f=j=g=i=d=a=null},_ajax:function(){var a=this.options,b=a.jsonStore.url,e=a.limit,d=this._offset,f=a.jsonStore;h===b||""===b?(b=(f.data.rows||f.data)[0],h===b||h===b[a.mapper[0].name]?alert("Invalid JSON"):this._createRows(f.data,"local"),b=null):("string"===
typeof f.params?f.params=0===d?f.params+"&limit="+e+"&offset="+d:f.params.replace(/(&offset=)(.+)/,"&offset="+d):(h===f.params&&(f.params={}),f.params.limit=e,f.params.offset=d),c.ajax({type:a.ajaxMethod.toLowerCase(),url:b.replace(/\?.*/,""),data:f.params,dataType:"json",context:this,success:function(a){if(h!=a.error||0===a.length)return c.isFunction(this.options.onError)?this.options.onError.call(this.element[0]):alert(0===this.length?"Empty rows":this.error),!1;this._createRows(a,"ajax")}}))},
render:function(){var a=this,b,e=0;if(a._active())a.resetOffset(),a.load();else{c.isArray(a.options.toolBarButtons)&&(b=a.uiDataGridTfoot[0].rows[0].cells[0],c.map(a.options.toolBarButtons,function(d){(function(a){if(c.isFunction(d.fn))this.on("click",function(b){b.preventDefault();d.fn.apply(a.element[0],arguments);c(this).blur();return!1});this.button({icons:{primary:h===d.icon?null:"ui-icon-"+d.icon}});b.appendChild(this[0])}).call(c("<button>").text(d.label),a)}),b=null);a.uiDataGrid.appendTo(a.element);
a._createColumns();a.resize();if(a.options.autoLoad){var e=180,d=a;setTimeout(function(){d.load()},e)}if(c.isFunction(a.options.onComplete)){var f=a;setTimeout(function(){f.options.onComplete.call(f.element[0])},e+1)}}a=null;return this},_nextPage:function(){this._offset+=this.options.limit},_prevPage:function(){this._offset-=this.options.limit},_endPage:function(){this._offset=this._totalPages*this.options.limit-this.options.limit},_firstPage:function(){this._offset=0},_tbodyEvents:function(){if(c.isFunction(this.options.onClickRow))this.uiDataGridTbody.off().on("click",
"tr",function(a){return function(b){c(this).addClass("ui-state-highlight");a.options.onClickRow.call(a.element[0],this,b);var e=a.uiDataGridTbody[0],d=c.data(e,"rowselected");b.currentTarget!==d[0]&&d.removeClass("ui-state-highlight");c.data(e,"rowselected",c(b.currentTarget))}}(this));return this},_active:function(){return this.element.children(":eq(0)").hasClass("ui-datagrid-container")},_getBHF:function(a,b){return c.isFunction(b)?b.call(a[0]):a},resize:function(){this.options.fit&&function(a){a=
a.uiDataGrid.outerHeight()-a.element.height();this.style.height=c(this).height()-a+"px"}.call(this.uiDataGridScrollBody[0],this);return this},getSelectedRow:function(){return c.data(this.uiDataGridTbody[0],"rowselected")},clearSelectedRow:function(){(function(){c.data(this,"rowselected").removeClass("ui-state-highlight");c.data(this,"rowselected",c([]))}).call(this.uiDataGridTbody[0])},load:function(){this._ajax();return this},widget:function(){return this.uiDataGrid},destroy:function(){c.Widget.prototype.destroy.call(this);
this.element.empty()},getOffset:function(){return this._offset},resetOffset:function(){this._offset=0},getThead:function(a){return this._getBHF(this.uiDataGridThead,a)},getTbody:function(a){return this._getBHF(this.uiDataGridTbody,a)},getTFoot:function(a){return this._getBHF(this.uiDataGridTfoot,a)},addRow:function(a){this._createRows(a,null,!0)}})})(jQuery,window,document);